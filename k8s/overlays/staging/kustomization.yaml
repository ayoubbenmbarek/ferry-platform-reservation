apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: maritime-reservations-staging

resources:
  - ../../base

namePrefix: staging-

commonLabels:
  environment: staging

# Patches for staging-specific configuration
patches:
  # Staging ingress with traefik and staging subdomains
  - path: ingress-patch.yaml
    target:
      kind: Ingress
      name: maritime-ingress
  # Reduce replicas for staging
  - patch: |-
      - op: replace
        path: /spec/replicas
        value: 1
    target:
      kind: Deployment
      name: backend
  - patch: |-
      - op: replace
        path: /spec/replicas
        value: 1
    target:
      kind: Deployment
      name: frontend
  - patch: |-
      - op: replace
        path: /spec/replicas
        value: 1
    target:
      kind: Deployment
      name: celery-worker

  # ConfigMap patches for staging
  - patch: |-
      - op: replace
        path: /data/ENVIRONMENT
        value: "staging"
      - op: replace
        path: /data/DEBUG
        value: "true"
      - op: replace
        path: /data/LOG_LEVEL
        value: "DEBUG"
      - op: replace
        path: /data/ALLOWED_ORIGINS
        value: "https://staging.maritime-reservations.com,https://api-staging.maritime-reservations.com"
      - op: replace
        path: /data/GOOGLE_REDIRECT_URI
        value: "https://api-staging.maritime-reservations.com/api/v1/auth/google/callback"
      - op: replace
        path: /data/BASE_URL
        value: "https://staging.maritime-reservations.com"
      - op: replace
        path: /data/SENTRY_ENVIRONMENT
        value: "staging"
      - op: replace
        path: /data/SENTRY_TRACES_SAMPLE_RATE
        value: "1.0"
    target:
      kind: ConfigMap
      name: maritime-config

# Image overrides for staging (will be set by CI/CD)
images:
  - name: maritime-reservations/backend
    newName: ghcr.io/ayoubmbarek/maritime-reservation-website/backend
    newTag: staging
  - name: maritime-reservations/frontend
    newName: ghcr.io/ayoubmbarek/maritime-reservation-website/frontend
    newTag: staging
  - name: maritime-reservations/chatbot
    newName: ghcr.io/ayoubmbarek/maritime-reservation-website/chatbot
    newTag: staging
