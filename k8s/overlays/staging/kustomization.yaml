apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: maritime-reservations-staging

resources:
  - ../../base

namePrefix: staging-

commonLabels:
  environment: staging

# Patches for staging-specific configuration
patches:
  # Staging ingress with traefik and staging subdomains
  - path: ingress-patch.yaml
    target:
      kind: Ingress
      name: maritime-ingress

  # Fix REDIS_URL to use staging-prefixed service name
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/env
        value:
          - name: HOST
            value: "0.0.0.0"
          - name: PORT
            value: "8010"
          - name: REDIS_URL
            value: "redis://staging-redis-service:6379/0"
    target:
      kind: Deployment
      name: backend
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/env/0
        value:
          name: REDIS_URL
          value: "redis://staging-redis-service:6379/0"
    target:
      kind: Deployment
      name: celery-worker
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/env/0
        value:
          name: REDIS_URL
          value: "redis://staging-redis-service:6379/0"
    target:
      kind: Deployment
      name: celery-beat

  # Reduce replicas for staging
  - patch: |-
      - op: replace
        path: /spec/replicas
        value: 1
    target:
      kind: Deployment
      name: backend
  - patch: |-
      - op: replace
        path: /spec/replicas
        value: 1
    target:
      kind: Deployment
      name: frontend
  - patch: |-
      - op: replace
        path: /spec/replicas
        value: 1
    target:
      kind: Deployment
      name: celery-worker
  # Reduce HPA minReplicas for staging
  - patch: |-
      - op: replace
        path: /spec/minReplicas
        value: 1
      - op: replace
        path: /spec/maxReplicas
        value: 2
    target:
      kind: HorizontalPodAutoscaler
      name: backend-hpa
  - patch: |-
      - op: replace
        path: /spec/minReplicas
        value: 1
      - op: replace
        path: /spec/maxReplicas
        value: 2
    target:
      kind: HorizontalPodAutoscaler
      name: frontend-hpa
  - patch: |-
      - op: replace
        path: /spec/minReplicas
        value: 1
      - op: replace
        path: /spec/maxReplicas
        value: 2
    target:
      kind: HorizontalPodAutoscaler
      name: celery-worker-hpa

  # ConfigMap patches for staging
  - patch: |-
      - op: replace
        path: /data/ENVIRONMENT
        value: "staging"
      - op: replace
        path: /data/DEBUG
        value: "true"
      - op: replace
        path: /data/LOG_LEVEL
        value: "DEBUG"
      - op: replace
        path: /data/ALLOWED_ORIGINS
        value: "https://staging.voilaferry.com,https://api-staging.voilaferry.com"
      - op: replace
        path: /data/GOOGLE_REDIRECT_URI
        value: "https://api-staging.voilaferry.com/api/v1/auth/google/callback"
      - op: replace
        path: /data/BASE_URL
        value: "https://staging.voilaferry.com"
      - op: replace
        path: /data/SENTRY_ENVIRONMENT
        value: "staging"
      - op: replace
        path: /data/SENTRY_TRACES_SAMPLE_RATE
        value: "1.0"
    target:
      kind: ConfigMap
      name: maritime-config

# Image overrides for staging (will be set by CI/CD)
images:
  - name: maritime-reservations/backend
    newName: ghcr.io/ayoubbenmbarek/ferry-platform-reservation/backend
    newTag: staging
  - name: maritime-reservations/frontend
    newName: ghcr.io/ayoubbenmbarek/ferry-platform-reservation/frontend
    newTag: staging
  - name: maritime-reservations/chatbot
    newName: ghcr.io/ayoubbenmbarek/ferry-platform-reservation/chatbot
    newTag: staging
